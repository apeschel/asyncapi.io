<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="In this tutorial I want to help you get started with actual code and a (could-be) real world use case." />





<meta itemprop="name" content="Streetlights | AsyncAPI Initiative">
<meta itemprop="description" content="In this tutorial I want to help you get started with actual code and a (could-be) real world use case.">
<meta itemprop="image" content="https://asyncapi.io/images/social/card.png">


<meta name="twitter:card" value="summary_large_image">
<meta name="twitter:title" content="Streetlights | AsyncAPI Initiative">
<meta name="twitter:description" content="In this tutorial I want to help you get started with actual code and a (could-be) real world use case.">
<meta name="twitter:image" content="https://asyncapi.io/images/social/card.png">


<meta property="og:title" content="Streetlights | AsyncAPI Initiative" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://asyncapi.io/docs/tutorials/streetlights/" />
<meta property="og:image" content="https://asyncapi.io/images/social/card.png" />
<meta property="og:description" content="In this tutorial I want to help you get started with actual code and a (could-be) real world use case." />
    <title>Streetlights | AsyncAPI Initiative</title>
    
<link rel="icon" type="image/png" href="https://asyncapi.io/images/favicon.png" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,400i,500,700">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/themes/prism.min.css">
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/line-numbers/prism-line-numbers.css">
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/line-highlight/prism-line-highlight.min.css">
<link rel="stylesheet" href="/css/bootstrap.min.css" />
<link rel="stylesheet" href="/css/font-icons.css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />

<link href="https://fonts.googleapis.com/css?family=Open&#43;Sans:400,600" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/style.min.5172582fa804cfda220339b467606ac77754d6551f6fb3e12e3f816429399687.css">

</head>

<body>
    <a href="https://github.com/asyncapi/asyncapi" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80"
            viewBox="0 0 250 250" style="fill:#46a2c7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"
            aria-hidden="true">
            <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
            <path
                d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
                fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path
                d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
                fill="currentColor" class="octo-body"></path>
        </svg></a>
    <style>
        .github-corner:hover .octo-arm {
            animation: octocat-wave 560ms ease-in-out
        }
    
        @keyframes octocat-wave {
    
            0%,
            100% {
                transform: rotate(0)
            }
    
            20%,
            60% {
                transform: rotate(-25deg)
            }
    
            40%,
            80% {
                transform: rotate(10deg)
            }
        }
    
        @media (max-width:500px) {
            .github-corner:hover .octo-arm {
                animation: none
            }
    
            .github-corner .octo-arm {
                animation: octocat-wave 560ms ease-in-out
            }
        }
    </style>
    


<header class="nav">
  <div class="nav__holder">
    <div class="container-fluid container-semi-fluid nav__container">
      <div class="flex-parent">

        <div class="nav__header">
          
          <a href="/" class="logo-container flex-child">
            <img class="logo" src="/img/logo.png" alt="AsyncAPI logo">
          </a>

          
          <button type="button" class="nav__icon-toggle" id="nav__icon-toggle" data-toggle="collapse"
            data-target="#navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="nav__icon-toggle-bar"></span>
            <span class="nav__icon-toggle-bar"></span>
            <span class="nav__icon-toggle-bar"></span>
          </button>
        </div>

        
        <nav id="navbar-collapse" class="nav__wrap collapse navbar-collapse">
          <ul class="nav__menu">
            <li class="nav__dropdown">
              <a>Learn</a>
              <i class="ui-arrow-down nav__dropdown-trigger"></i>
              <ul class="nav__dropdown-menu">
                <li><a href="/docs/getting-started" >Get started</a></li>
                <li><a href="/docs/tutorials" >Tutorials</a></li>
                <li><a href="/docs/specifications/latest" >Specification</a></li>
              </ul>
            </li>
            <li class="nav__dropdown">
              <a>Tooling</a>
              <i class="ui-arrow-down nav__dropdown-trigger"></i>
              <ul class="nav__dropdown-menu">
                <li><a href="http://playground.asyncapi.io?utm_source=asyncapi.io&amp;utm_medium=top-menu" target="_blank" >Playground</a></li>
                <li><a href="/docs/tooling#codegens" >Code generators</a></li>
                <li><a href="/docs/tooling#docgens" >Documentation generators</a></li>
                <li><a href="/docs/tooling#validators" >Validators</a></li>
                <li><a href="/docs/tooling#code-first" >Code-first tools</a></li>
              </ul>
            </li>
            <li>
              <a href="/blog">Blog</a>
            </li>
            <li class="nav__dropdown">
              <a>Help</a>
              <i class="ui-arrow-down nav__dropdown-trigger"></i>
              <ul class="nav__dropdown-menu">
                <li><a href="https://github.com/asyncapi/asyncapi" target="_blank" >Github repo</a></li>
                <li><a href="https://asyncapi.io/slack-invite" target="_blank" >Slack workspace</a></li>
              </ul>
            </li>
            <li>
              <a href="/about">About</a>
            </li>
            <li><a href="/docs/getting-started" style="font-weight: bold; color: #46a2c7;">Get Started</a></li>
          </ul> 
        </nav> 

        <div class="nav__btn-holder nav--align-right">
          
        </div>

      </div> 
    </div> 

  </div>
</header> 


    
    
<div class="container" style="padding:0 2rem;margin-top:30px;">
    <div class="row">
        <div class="col-md-3">
            <aside class="docs-menu">
    <h3>Menu</h3>
    <ul>
        
        
        
        <li>
            
                <a href="/docs/getting-started/">
                    
                    <span>Getting started</span>
                </a>
            
        </li>
        <ul class="sub-menu">
            
                
                <li>
                    <a href="/docs/getting-started/event-driven-architectures/">
                        
                        <span>Event-driven architectures</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/getting-started/coming-from-openapi/">
                        
                        <span>Coming from OpenAPI</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/getting-started/asyncapi-documents/">
                        
                        <span>AsyncAPI documents</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/getting-started/hello-world/">
                        
                        <span>Hello world</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/getting-started/servers/">
                        
                        <span>Servers</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/getting-started/publishing/">
                        
                        <span>Publishing</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/getting-started/reusing-messages/">
                        
                        <span>Reusing messages</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/getting-started/reusing-schemas/">
                        
                        <span>Reusing schemas</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/getting-started/security/">
                        
                        <span>Adding security</span>
                    </a>
                </li>
                
            
        </ul>
        
        
        
        <li>
            
                <a href="/docs/tutorials/">
                    
                    <span>Tutorials</span>
                </a>
            
        </li>
        <ul class="sub-menu">
            
                
                <li class="active">
                    
                    <span>Streetlights</span>
                </li>
                
            
        </ul>
        
        
        
        <li>
            
                <a href="/docs/specifications/latest">
                    
                    <span>Specification</span>
                </a>
            
        </li>
        <ul class="sub-menu">
            
                
                <li>
                    <a href="/docs/specifications/2.0.0-rc1/">
                        
                        <span>2.0.0-rc1</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/specifications/1.2.0/">
                        
                        <span>1.2.0</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/specifications/1.1.0/">
                        
                        <span>1.1.0</span>
                    </a>
                </li>
                
            
                
                <li>
                    <a href="/docs/specifications/1.0.0/">
                        
                        <span>1.0.0</span>
                    </a>
                </li>
                
            
        </ul>
        
        
    </ul>
</aside>
        </div>
        <div class="col-md-9">
        <div class="row">
    <div class="col-12">
        <h1 class="title section-title">Streetlights</h1>
    </div>
</div>
<div class="row">
    <div class="col-12 docs-content"><p>In this tutorial I want to help you get started with actual code and a (could-be) real world use case.</p>

<p>Let&rsquo;s pretend we have a company called Smarty Lighting and we do smart-city lighting systems.</p>

<h1 id="system-description">System Description<a href="#system-description" class="hanchor" ariaLabel="Anchor"> #&#xFE0E;</a> </h1>

<p>We want to create a system capable of turning on/off the streetlights depending on the environmental conditions of each of them:</p>

<ul>
<li>We&rsquo;re going to implement a message-driven architecture, with a Message Broker in its &ldquo;center&rdquo;.</li>
<li>Streetlights will send information about its environmental lighting to the broker.</li>
<li>None of the services will wait for any kind of response. Think about it as fire and forget. We&rsquo;ll publish messages to the broker and that&rsquo;s it. Our service don&rsquo;t know who will receive them.</li>
</ul>

<h1 id="technology">Technology<a href="#technology" class="hanchor" ariaLabel="Anchor"> #&#xFE0E;</a> </h1>

<p>We&rsquo;ll use Node.js to code our APIs and Mosquitto as our message broker. Please note this is just my choice for the tutorial but what is going to be explained here is applicable to any other programming language and other message brokers.</p>

<h1 id="the-asyncapi-file">The AsyncAPI file<a href="#the-asyncapi-file" class="hanchor" ariaLabel="Anchor"> #&#xFE0E;</a> </h1>

<p>Let&rsquo;s start by creating an AsyncAPI file to describe our API. It will help us generate the code and the documentation later.</p>

<pre><code class="language-yaml">asyncapi: '1.0.0'
info:
  title: Streetlights API
  version: '1.0.0'
  description: |
    The Smartylighting Streetlights API allows you
    to remotely manage the city lights.
  license:
    name: Apache 2.0
    url: 'https://www.apache.org/licenses/LICENSE-2.0'
baseTopic: smartylighting.streetlights.1.0

servers:
  - url: api.streetlights.smartylighting.com:{port}
    scheme: mqtt
    description: Test broker
    variables:
      port:
        description: Secure connection (TLS) is available through port 8883.
        default: '1883'
        enum:
          - '1883'
          - '8883'

topics:
  event.{streetlightId}.lighting.measured:
    publish:
      $ref: '#/components/messages/lightMeasured'

components:
  messages:
    lightMeasured:
      summary: Inform about environmental lighting conditions for a particular streetlight.
      payload:
        $ref: &quot;#/components/schemas/lightMeasuredPayload&quot;

  schemas:
    lightMeasuredPayload:
      type: object
      properties:
        lumens:
          type: integer
          minimum: 0
          description: Light intensity measured in lumens.
        sentAt:
          $ref: &quot;#/components/schemas/sentAt&quot;
    sentAt:
      type: string
      format: date-time
      description: Date and time when the message was sent.
</code></pre>

<p>Let&rsquo;s break it down into pieces:</p>

<pre><code class="language-yaml">asyncapi: '1.0.0'
  info:
    title: Streetlights API
    version: '1.0.0'
    description: |
      The Smartylighting Streetlights API allows you
      to remotely manage the city lights.
    license:
      name: Apache 2.0
      url: 'https://www.apache.org/licenses/LICENSE-2.0'
  baseTopic: smartylighting.streetlights.1.0
</code></pre>

<ul>
<li>The <code>asyncapi</code> field indicates we want to use AsyncAPI version 1.0.0.</li>
<li>Inside the <code>info</code> field we can find information about the API, like its name, version, a description and its license.</li>
<li>The <code>baseTopic</code> field is a string that will be prepended to the topics we&rsquo;ll be defining afterwards. It is optional.</li>
</ul>

<p>We&rsquo;re now going for the topics section. It is used to describe the event names or action names your API will be publishing and/or subscribing to.</p>

<pre><code class="language-yaml">topics:
  event.{streetlightId}.lighting.measured:
    publish:
      $ref: '#/components/messages/lightMeasured'
</code></pre>

<p>Here <code>event.{streetlightId}.lighting.measured</code> is the topic name your API will allow you to publish to. The <code>{streetlightId}</code> part is a variable and it means you can actually specify whatever there. Remember the baseTopic we mentioned before? Well, it means that your API will actually be subscribed to <code>smartylighting.streetlights.1.0.event.{streetlightId}.lighting.measured</code>, but to avoid repeating the first part in every topic we decided to move it to the baseTopic field.</p>

<p>Something we should take into account when we see <code>$ref: '#/components/messages/turnOnOff'</code> is that <code>$ref</code> references a URL. This means that <code>#</code> refers to our document (like in websites), but it could be a URL pointing to an external file.</p>

<p>Next up is our components section:</p>

<pre><code class="language-yaml">components:
  messages:
    ...

  schemas:
    ...
</code></pre>

<p>The components section can contain messages, schemas and security schemes - we&rsquo;re not using security schemes for simplicity. In the messages subsection we&rsquo;ll define how our messages will look like and, in the schemas section, we&rsquo;ll put reusable pieces of the data the messages will contain.</p>

<pre><code class="language-yaml">components:
  messages:
    lightMeasured:
      summary: Inform about environmental lighting conditions for a particular streetlight.
      payload:
        $ref: &quot;#/components/schemas/lightMeasuredPayload&quot;
</code></pre>

<p>Here we&rsquo;re describing the a message that we&rsquo;re going to use for our example. A message can contain a summary, a description, a payload, etc. <a href="https://github.com/asyncapi/asyncapi#messageObject" target="_blank">Learn more here.</a></p>

<p>Let&rsquo;s pay special attention to the payload attribute, which references a schema defining how the message data is structured.</p>

<pre><code class="language-yaml">components:
  schemas:
    lightMeasuredPayload:
      type: object
      properties:
        lumens:
          type: integer
          minimum: 0
          description: Light intensity measured in lumens.
        sentAt:
          $ref: &quot;#/components/schemas/sentAt&quot;
    sentAt:
      type: string
      format: date-time
      description: Date and time when the message was sent.
</code></pre>

<p>It will be an object containing 2 properties: lumens and sentAt. The former is a number describing the light intensity and the second is a date-time string indicating when the message was sent. We can describe much more things using the JSON schema syntax, <a href="https://github.com/asyncapi/asyncapi#schemaObject" target="_blank">check out here</a>.</p>

<p>Cool! So we&rsquo;re done with our AsyncAPI file!</p>

<h1 id="generating-code">Generating code<a href="#generating-code" class="hanchor" ariaLabel="Anchor"> #&#xFE0E;</a> </h1>

<p>To generate our code we&rsquo;ll use the <a href="https://www.npmjs.com/package/asyncapi-node-codegen" target="_blank">AsyncAPI Node.js code generator</a>.</p>

<pre><code class="language-bash">npm install -g asyncapi-node-codegen
</code></pre>

<p>(You might need to use sudo)</p>

<p>Create a directory for your projects and step into it:</p>

<pre><code class="language-bash">mkdir streetlights &amp;&amp; cd &quot;$_&quot;
</code></pre>

<p>Create a file with the AsyncAPI machine-readable description we created before:</p>

<pre><code class="language-bash">touch asyncapi.yml
# Open asyncapi.yml and paste the definition
</code></pre>

<p>And now let&rsquo;s generate the code for it:</p>

<pre><code class="language-bash">asyncapi-node-codegen asyncapi.yml .
</code></pre>

<p>And voilà!</p>

<h1 id="running-our-code">Running our code<a href="#running-our-code" class="hanchor" ariaLabel="Anchor"> #&#xFE0E;</a> </h1>

<p>Before running your code don&rsquo;t forget to install the dependencies on every project:</p>

<pre><code class="language-bash">npm install
</code></pre>

<p>Then go to <code>config/common.yml</code> and change the default mqtt host to <code>mqtt://test.mosquitto.org</code> and default mqtt topics to <code>smartylighting/streetlights/1/0/event/#</code>.</p>

<p>Finally you can run the code by simply running <code>npm start</code>.</p>

<p>Now that you have your code running you&rsquo;ll want to test it, right? Go and install the mqtt library:</p>

<pre><code class="language-bash">npm install mqtt -g
</code></pre>

<p>(You might need to use sudo)</p>

<p>Try to send messages to your service using the command line:</p>

<pre><code class="language-bash">mqtt pub -t 'smartylighting/streetlights/1/0/event/farolina/lighting/measured' -h 'test.mosquitto.org' -m '{&quot;lumens&quot;: 3, &quot;sentAt&quot;: &quot;2017-06-07T12:34:32.000Z&quot;}'
</code></pre>

<p>You should see our application logging the message you just sent.</p>

<h1 id="conclusions">Conclusions<a href="#conclusions" class="hanchor" ariaLabel="Anchor"> #&#xFE0E;</a> </h1>

<p>We&rsquo;ve learned how to create an AsyncAPI description file and how to generate code from it. The code is just a bootstrap and you&rsquo;ll need to add your business logic into it. Take some time to play with it.
There are still lots of things to be covered but I kept the tutorial simple on purpose, so you get an idea of the potential.</p>

<p>We would also like to see what you create with AsyncAPI. As an open-source project we&rsquo;re open to proposals, questions, suggestions and contributions. If you don&rsquo;t feel in the mood to contribute but you&rsquo;re using AsyncAPI, just raise your hand <a href="https://github.com/asyncapi/asyncapi/issues/new" target="_blank">creating a issue in our Github repo</a> or <a href="https://async-apis-slack.herokuapp.com/" target="_blank">join our Slack channel</a>. Don&rsquo;t be shy :)</p></div>
</div>
        </div>
    </div>
</div>

<footer class="footer">
  <div class="container">
    <div class="footer__widgets">
      <div class="row">

        <div class="col-lg-3 col-md-6">
          <div class="widget widget-about-us">
            
            <a href="index.html" class="logo-container flex-child">
              <img class="logo" src="/img/logo.png" alt="AsyncAPI logo">
            </a>
            <p class="mt-24 mb-32">Building the future of event-driven architectures.</p>
            <div class="socials">
              <a href="https://twitter.com/AsyncAPISpec" class="social social-twitter" aria-label="twitter"
                title="Twitter" target="_blank"><i class="ui-twitter"></i></a>
              <a href="https://www.linkedin.com/company/asyncapi" class="social social-linkedin" aria-label="linkedin"
                title="LinkedIn" target="_blank"><i class="ui-linkedin"></i></a>
            </div>
          </div>
        </div> 


        <div class="col-lg-2 offset-lg-6 col-md-6">
          <div class="widget widget_nav_menu">
            <h5 class="widget-title">Resources</h5>
            <ul>
              <li><a href="/about">About</a></li>
              <li><a href="/blog">Blog</a></li>
              <li><a href="https://github.com/asyncapi" target="_blank">Github</a></li>
            </ul>
          </div>
        </div>

      </div>
    </div>
  </div> 

  <div class="footer__bottom top-divider">
    <div class="container text-center">
      <span class="copyright">
        Made with <code>:love:</code> by the AsyncAPI Initiative.
      </span>
    </div>
  </div> 
</footer> 

<div id="back-to-top">
  <a href="#top"><i class="ui-arrow-up"></i></a>
</div>


    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-132780191-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'UA-132780191-2');
</script>


<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/plugins.js"></script>
<script src="/js/scripts.js"></script>


<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script src="/js/cookies.js"></script>


<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/prism.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-yaml.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/components/prism-json.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/line-numbers/prism-line-numbers.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.15.0/plugins/line-highlight/prism-line-highlight.min.js"></script>

<script>
    $('pre code').addClass('line-numbers');
</script>


<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function (regs) {
      if (regs && regs.length > 0) {
        for (var registration of regs) {
          registration.unregister();
        }
      }
    });
  }
</script>
</body>

</html>